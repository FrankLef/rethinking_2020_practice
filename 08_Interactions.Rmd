```{r include=FALSE}
library(dplyr, quietly = TRUE)
library(tidyr, quietly = TRUE)
library(tidybayes, quietly = TRUE)
library(rethinking)
library(brms)
library(loo)
library(dagitty, quietly = TRUE)
library(ggdag, quietly = TRUE)
library(ggdist, quietly = TRUE)
library(patchwork, quietly = TRUE)
library(paletteer, quietly = TRUE)
```


# Conditional Manatees {#interactions}


## 8E1 {-}

### (1) {-}

Heat

### (2) {-}

Socio-economic situation

### (3) {-}

Electricity (e.g. from battery)

## 8E2 {-}

### (1) {-}

Interaction. Heat and moisture interact to obtain cooking effect.
The word "condition" is key here.


### (2) {-}

Additive, no interaction (although this is arguable).
The word "or" defines the situation


### (3) {-}

Additive, you can get opinions from both without
them interacting with each other. The word "unless" is a key word.

### (4) {-}

Additive, no interaction.  The word "or" indicates either one can be
used.


## 8E3 {-}

### (1) {-}

$$
\begin{align*}
cooking_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_1 \cdot heat_i +\beta_2 \cdot moist_i + 
\beta_{3} \cdot moist_i \cdot heat_i
\end{align*}
$$

### (2) {-}


$$
\begin{align*}
speed_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_1 \cdot cylinders_i +\beta_2 \cdot injection_i
\end{align*}
$$


### (3) {-}


$$
\begin{align*}
belief_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_1 \cdot parents_i +\beta_2 \cdot friends_i
\end{align*}
$$



### (4) {-}


$$
\begin{align*}
intelligence_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_1 \cdot social_i +\beta_2 \cdot appendage_i
\end{align*}
$$

## 8M1 {-}

Temperature interacts with water and/or shade to either cancel the water effect or
increase the effect of shade or both.

## 8M2 {-}

Let the binary variable $T$ be the temperature effect where $H=1$ means it is 
hot and $H=0$ when it is cold.

and the initial model

$$
\mu_i \sim \alpha + \beta_W \cdot water\_c_i + \beta_S \cdot shade\_c_i
$$

now becomes


$$
\mu_i \sim \alpha + (1 - H_i) \cdot \beta_W \cdot water\_c_i + H_i \cdot \beta_S \cdot shade\_c_i
$$


## 8M3 {-}

The relationship is that ravens depend on wolves for their food but the wolves
don't depend on the raven.  The question states that ravens depends on wolves.
It is not clear that they depend entirely as a parasite does for example.

The data would be one where ravens success increases as function of wolves
success.  It is not an interaction which would cause the presence of ravens and
wolves to impact their mutual success in a way similar as if a third variable
affected both and increase as well as decrease their mutual success.


## 8H1 {-}

```{r}
data(tulips, package = "rethinking")
d <- tulips %>%
  mutate(blooms_r = scales::rescale(blooms),
         water_c = as.vector(scale(water, scale = FALSE)),
         shade_c = as.vector(scale(shade, scale = FALSE)))
stopifnot(is.factor(d$bed))  # must be a factor to use with brms as category
rm(tulips)
skimr::skim(d)
```

### Model and fit {-}

$$
\begin{align*}
blooms\_r_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha_{bed[i]} + \beta_W \cdot water\_c_i+ \beta_S \cdot shade\_c_i \\
\alpha_{bed[i]} &\sim \mathcal{N}(0.5, 1) \\
\beta_W &\sim \mathcal{N}(0, 1) \\
\beta_S &\sim \mathcal{N}(0, 1) \\
\sigma &\sim \mathcal{Exp}(1)
\end{align*}
$$


```{r}
a_file <- here::here("fits", "b08H01.rds")
b08H01 <- readRDS(file = a_file)
# b08H01 <- brm(
#   data = d,
#   family = gaussian,
#   formula = blooms_r ~ 0 + bed + water_c + shade_c,
#   prior = c(prior(normal(0.5, 0.25), class = b),
#             prior(normal(0, 0.25), class = b, coef = water_c),
#             prior(normal(0, 0.25), class = b, coef = shade_c),
#             prior(exponential(1), class = sigma)),
#   iter = 2000, warmup = 1000, chains = 4, cores = detectCores(), seed = 8)
# b08H01 <- brms::add_criterion(b08H01, criterion = c("waic", "loo"))
# saveRDS(b08H01, file = a_file)
summary(b08H01)
```


## 8H2 {-}


```{r}
a_file <- here::here("fits", "b08H02.rds")
b08H02 <- readRDS(file = a_file)
# b08H02 <- brm(
#   data = d,
#   family = gaussian,
#   formula = blooms_r ~ 1 + water_c + shade_c,
#   prior = c(prior(normal(0.5, 0.25), class = Intercept),
#             prior(normal(0, 0.25), class = b),
#             prior(exponential(1), class = sigma)),
#   iter = 2000, warmup = 1000, chains = 4, cores = detectCores(), seed = 8)
# b08H02 <- brms::add_criterion(b08H02, criterion = c("waic", "loo"))
# saveRDS(b08H02, file = a_file)
summary(b08H02)
```


```{r}
w <- loo::loo_compare(b08H01, b08H02, criterion = "waic")
print(w, simplify = FALSE)
```

The water and shade effect is the same.  Now however the intercept or 0.36 is
the same as the mean of the 3 bed intercepts we had in 8H1 above.  In other words
the model in 8H1 breaks down the intercept into the three beds showing their ingluence
on the growth.

## 8H3 {-}


```{r}
data(rugged)
d <- rugged %>%
  filter(complete.cases(rgdppc_2000)) %>%
  mutate(log_gdp = log(rgdppc_2000),
         is_africa = if_else(cont_africa == 1, "Africa", "Not Africa"),
         is_africa = as.factor(is_africa),
         cid = if_else(cont_africa == 1, "1", "2"),
         cid = as.factor(cid),
         log_gdp_s = log_gdp / mean(log_gdp),
         rugged_s = scales::rescale(rugged),
         rugged_sc = as.vector(scale(rugged_s, center = TRUE, scale = FALSE))
         )
rm(rugged)
# glimpse(d)
```


> Errata: Model m8.5 is with the tulips data, not the rugged data.  It must be
model m8.3 that is meant.  See in first edition the practice 7H3.

Model m8.3 is as follows


$$
\begin{align*}
\log{(log\_gdp\_s_i)} &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha_{[cid]} + \beta_{[cid]} \cdot rugged\_sc_i \\
\alpha &\sim \mathcal{N}(1, 0.1) \\
\beta &\sim \mathcal{N}(0, 0.3) \\
\sigma &\sim \mathcal{Exp}(1)
\end{align*}
$$

See section 8.1.3 on how to fit the b8.3 model which is the `brms` version of
m8.3.

```{r}
a_file <- here::here("fits", "b08H03.rds")
b08H03 <- readRDS(file = a_file)
# b08H03 <-
#   brm(data = d,
#       family = gaussian,
#       formula = bf(log_gdp_s ~ 0 + a + b * rugged_sc,
#          a ~ 0 + cid,
#          b ~ 0 + cid,
#          nl = TRUE),
#       prior = c(prior(normal(1, 0.1), class = b, coef = cid1, nlpar = a),
#                 prior(normal(1, 0.1), class = b, coef = cid2, nlpar = a),
#                 prior(normal(0, 0.3), class = b, coef = cid1, nlpar = b),
#                 prior(normal(0, 0.3), class = b, coef = cid2, nlpar = b),
#                 prior(exponential(1), class = sigma)),
#       iter = 2000, warmup = 1000, chains = 4, cores = detectCores(), seed = 8)
# b08H03 <- brms::add_criterion(b08H03, criterion = c("waic", "loo"))
# saveRDS(b08H03, file = a_file)
summary(b08H03)
```

### (a) {-}

See section 7.5.2 on how to show outliers


```{r}
dp <- tibble(pareto_k = b08H03$criteria$loo$diagnostics$pareto_k,
       p_waic = b08H03$criteria$waic$pointwise[, "p_waic"],
       country = d$country,
       is_africa = d$is_africa)
# glimpse(dp)
waic_max <- 0.3
k_max <- 0.3
ggplot(dp, aes(x = pareto_k, y = p_waic, color = is_africa)) +
  geom_vline(xintercept = waic_max, linetype = 2, color = "purple") +
  geom_hline(yintercept = k_max, linetype = 2, color = "purple") +
  geom_point() +
  ggrepel::geom_text_repel(data = . %>% filter(p_waic >= waic_max),
                           aes(label = country)) +
  scale_color_manual(values = c("Africa" = "darkgreen", "Not Africa" = "violetred")) +
  scale_shape_manual(values = c(19, 19)) +
  theme_minimal() +
  theme(legend.position = c(0.1, 0.85),
        legend.title = element_blank(),
        title = element_text(color = "midnightblue")) +
  labs(title = "Practice 8H3 (a)",
       subtitle = deparse1(b08H03$formula$formula))
```
Beside Seychelles, Swizterland is also an outlier.  Probably because Switzerland
has a high GDP in spite of being rugged.

### (b) {-}

See section 7.5.2 on ow to do the robust regression with student distribution.

```{r}
a_file <- here::here("fits", "b08H03t.rds")
b08H03t <- readRDS(file = a_file)
# b08H03t <-
#   brm(data = d,
#       family = student,
#       formula = bf(log_gdp_s ~ 0 + a + b * rugged_sc,
#          a ~ 0 + cid,
#          b ~ 0 + cid,
#          nl = TRUE,
#          nu = 2),
#       prior = c(prior(normal(1, 0.1), class = b, coef = cid1, nlpar = a),
#                 prior(normal(1, 0.1), class = b, coef = cid2, nlpar = a),
#                 prior(normal(0, 0.3), class = b, coef = cid1, nlpar = b),
#                 prior(normal(0, 0.3), class = b, coef = cid2, nlpar = b),
#                 prior(exponential(1), class = sigma)),
#       iter = 2000, warmup = 1000, chains = 4, cores = detectCores(), seed = 8)
# b08H03t <- brms::add_criterion(b08H03t, criterion = c("waic", "loo"))
# saveRDS(b08H03t, file = a_file)
summary(b08H03t)
```

Comparing the results

```{r}
w <- loo::loo_compare(b08H03, b08H03t, criterion = "waic")
print(w, simplify = FALSE)
```
Therefore the Student distribution has less precision . . . but is more robust.
That is, it is less impacted by outliers.  This is a clasic trade-off between
precision and robustness.


and to visualize the outliers which have much less impact now we have
the following plot


```{r}
dp <- tibble(pareto_k = b08H03t$criteria$loo$diagnostics$pareto_k,
       p_waic = b08H03t$criteria$waic$pointwise[, "p_waic"],
       country = d$country,
       is_africa = d$is_africa)
# glimpse(dp)
waic_max <- 0.3
k_max <- 0.3
ggplot(dp, aes(x = pareto_k, y = p_waic, color = is_africa)) +
  geom_vline(xintercept = waic_max, linetype = 2, color = "purple") +
  geom_hline(yintercept = k_max, linetype = 2, color = "purple") +
  geom_point() +
  ggrepel::geom_text_repel(data = . %>% filter(p_waic >= waic_max),
                           aes(label = country)) +
  scale_color_manual(values = c("Africa" = "darkgreen", "Not Africa" = "violetred")) +
  scale_shape_manual(values = c(19, 19)) +
  theme_minimal() +
  theme(legend.position = c(0.1, 0.85),
        legend.title = element_blank(),
        title = element_text(color = "midnightblue")) +
  labs(title = "Practice 8H3 (b) - Student distribution",
       subtitle = deparse1(b08H03t$formula$formula))
```

## 8H4 {-}

As required in the question, we use $log(lang.per.cap)$. This gives
$lang.per.cap.log \in [-10,0]$.  To avoid the negative outcome which cause
a positive slope (required by our hypothesis), we rescale $lang.per.cap.log$
to be in $[0,10]$



```{r}
data(nettle)
d <- nettle %>%
  mutate(area.log = log(area),
         lang.per.cap = num.lang / k.pop,
         lang.per.cap.log = log(lang.per.cap),
         lang.per.cap.log = scales::rescale(lang.per.cap.log, to = c(0, 10)))
rm(nettle)
skimr::skim(d)
```

### (a) {-}

#### The priors {-}

See section 8.1.1 on how to estimate the priors.

Since $lang.per.cap.log \in [0,10]$ with mean about 5 then we use
$\alpha \sim \mathcal{N}(5,2.5)$.

Since $lang.per.cap.log \in [0,10]$ $mean.growing.season \in [0,12]$ 
which gives a maximum slope of $\frac{10-0}{12-0} \approx 1$ which should be a 
positive slope since we have the hypothesis that language diversity increases 
with the $mean.growing.season$. Therefore $\beta_{GM} &\sim \mathcal{N}(0.5,0.25)$

Similarly, since $lang.per.cap.log \in [0,10]$ and $area.log \in [9,16]$ 
which gives a maximum slope of $\frac{10-0}{16-9} \approx 1.5$ which should be 
positive slope since we have the hypothesis that language diversity increases with the $area.log$.
Therefore $\beta_{A} &\sim \mathcal{N}(0.75,0.5)$


#### The model {-}

$$
\begin{align*}
lang.per.cap.log_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_{GM} \cdot mean.growing.season_i + \beta_A \cdot area.log_i \\
\alpha &\sim \mathcal{N}(5,2.5) \\
\beta_{GM} &\sim \mathcal{N}(0.5,0.25) \\
\beta_{A} &\sim \mathcal{N}(0.75,0.5) \\
\sigma &\sim \mathcal{Exp}(1)
\end{align*}
$$

#### The fit {-}

```{r}
a_file <- here::here(getwd(), "fits", "b08H04a.rds")  # rds file location
b08H04a <- readRDS(file = a_file)
# b08H04a <- brm(
#   data = d,
#   formula = lang.per.cap.log ~ 1 + mean.growing.season + area.log,
#   family = gaussian,
#   prior = c(
#     prior(normal(5, 2.5), class = Intercept),
#     prior(normal(0.5, 0.25), class = b, coef = "mean.growing.season"),
#     prior(normal(0.75, 0.5), class = b, coef = "area.log"),
#     prior(exponential(1), class = sigma)
#   ),
#   sample_prior = TRUE,
#   iter = 2000, warmup = 1000, chains = 4, cores = detectCores(),
#   seed = 8
# )
# b08H04a <- brms::add_criterion(b08H04a, criterion = c("waic", "loo"))
# saveRDS(b08H04a, file = a_file)
print(b08H04a, digits = 3)
```

#### Validate the priors {-}



```{r}
# stop("TODO")
set.seed(8)
b08H04a_prior <- prior_samples(b08H04a)
glimpse(b08H04a_prior)
pd <-
  b08H04a_prior %>%
  slice_sample(n = 50) %>%
  tibble::rownames_to_column() %>%
  expand(nesting(rowname, Intercept, b_mean.growing.season), mean.growing.season = c(0, 12)) %>%
  mutate(lang.per.cap.log = Intercept + b_mean.growing.season * mean.growing.season)
         # rugged_s  = rugged_sc + mean(dd$rugged_s))
glimpse(pd)

p1 <- ggplot(pd, aes(x = mean.growing.season, y = lang.per.cap.log, group = rowname)) +
  geom_line(color = "lavender") +
  geom_hline(yintercept = range(d$lang.per.cap.log),
             size = 1, linetype = 2, color = "royalblue") +
  coord_cartesian(xlim = c(0, 12), ylim = c(-5, 15)) +
  labs(
    subtitle = "Intercept ~ dnorm(5, 2.5)\nb ~ dnorm(0.5, 0.25)",
    x = "mean.growing.season",
    y = "lang.per.cap.log") +
  ggthemes::theme_hc()
# p1
pd <-
  b08H04a_prior %>%
  slice_sample(n = 50) %>%
  tibble::rownames_to_column() %>%
  expand(nesting(rowname, Intercept, b_area.log), area.log = c(9, 16)) %>%
  mutate(lang.per.cap.log = Intercept + b_area.log * area.log)
p2 <- ggplot(pd, aes(x = area.log, y = lang.per.cap.log, group = rowname)) +
  geom_line(color = "lavender") +
  geom_hline(yintercept = range(d$lang.per.cap.log),
             size = 1, linetype = 2, color = "royalblue") +
  coord_cartesian(xlim = c(9, 16), ylim = c(-5, 15)) +
  labs(
    subtitle = "Intercept ~ dnorm(5, 2.5)\nb ~ dnorm(0.75, 0.5)",
    x = "area.log",
    y = "lang.per.cap.log") +
  ggthemes::theme_hc()
# p2
p1 + p2
```

