```{r include=FALSE}
library(rethinking)
library(brms)
library(dplyr, quietly = TRUE)
library(tidyr, quietly = TRUE)
library(tidybayes, quietly = TRUE)
library(ggdist, quietly = TRUE)
library(patchwork, quietly = TRUE)
library(paletteer, quietly = TRUE)
```


# Structural Causal Models {#SCM}


## 6E1 {-}



## 6H1 {-}


## 6H2 {-}

```{r}
data(foxes)
d <- foxes %>%
  mutate(
    W = scale(as.vector(weight)),
    A = scale(as.vector(area)),
    S = scale(as.vector(groupsize))
  )
skimr::skim(d)
```

### 6H2 a) By territory area size {-}

$$
\begin{align*}
W_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta \cdot A_i \\
\alpha &\sim \mathcal{N}(0, 0.5) \\
\beta &\sim \mathcal{N}(0, 0.2) \\
\sigma &\sim \mathcal{HalfCauchy}(0, 1)
\end{align*}
$$

and the fit

```{r}
a_file <- here::here("fits", "b06H02a.rds")
b06H02a <- readRDS(file = a_file)
# b06H02a <- brm(
#   data = d,
#   formula = W ~ 1 + A,
#   family = gaussian,
#   prior = c(
#     prior(normal(0, 0.5), class = Intercept),
#     prior(normal(0, 0.2), class = b),
#     prior(cauchy(0, 1), class = sigma)
#   ),
#   iter = 2000, warmup = 1000, chains = 4, core = detectCores(),
#   seed = 6
# )
# save(b06H02a, file = a_file)
summary(b06H02a)
```

and create the full data for plotting

```{r}
# get the fitted data, i.e. for mu
b06H02a_fitted <- fitted(b06H02a) %>%
  as_tibble() %>%
  rename(
    fit = Estimate,
    fit_err = Est.Error,
    fit_Q2.5 = Q2.5,
    fit_Q97.5 = Q97.5,
  )
# str(f)
# get the predicted data, i.e. for y
b06H02a_predict <- predict(b06H02a) %>%
  as_tibble() %>%
  rename(
    pred = Estimate,
    pred_err = Est.Error,
    pred_Q2.5 = Q2.5,
    pred_Q97.5 = Q97.5,
  )
# str(p)
b06H02a_df <- d %>%
  bind_cols(b06H02a_fitted) %>%
  bind_cols(b06H02a_predict)
# glimpse(b06H02a)
```



```{r}
ggplot(data = b06H02a_df, mapping = aes(x = A, y = W)) +
  geom_ribbon(aes(ymin = pred_Q2.5, ymax = pred_Q97.5),
              fill = "olivedrab1", alpha = 0.5) +
  geom_ribbon(aes(ymin = fit_Q2.5, ymax = fit_Q97.5),
              fill = "olivedrab3", alpha = 0.5) +
  geom_line(aes(y = fit), color = "olivedrab4") +
  geom_point(aes(color = group)) +
  scale_color_paletteer_c("oompaBase::jetColors") + 
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Practice 6H1a: Weight vs Area Size",
       color = "group",
       x = "area size (std)", y = "weight (std)")
```


### 6H2 b) By group size {-}


$$
\begin{align*}
W_i &\sim \mathcal{N}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta \cdot S_i \\
\alpha &\sim \mathcal{N}(0, 0.5) \\
\beta &\sim \mathcal{N}(0, 0.2) \\
\sigma &\sim \mathcal{HalfCauchy}(0, 1)
\end{align*}
$$

and the fit

```{r}
a_file <- here::here("fits", "b06H02b.rds")
b06H02b <- readRDS(file = a_file)
# b06H02b <- brm(
#   data = d,
#   formula = W ~ 1 + S,
#   family = gaussian(),
#   prior = c(
#     prior(normal(0, 0.5), class = Intercept),
#     prior(normal(0, 0.2), class = b),
#     prior(cauchy(0, 1), class = sigma)
#   ),
#   iter = 2000, warmup = 1000, chains = 4, core = detectCores(),
#   seed = 6
# )
# saveRDS(b06H02b, file = a_file)
summary(b06H02b)
```

and create the full data for plotting

```{r}
# get the fitted data, i.e. for mu
b06H02b_fitted <- fitted(b06H02b) %>%
  as_tibble() %>%
  rename(
    fit = Estimate,
    fit_err = Est.Error,
    fit_Q2.5 = Q2.5,
    fit_Q97.5 = Q97.5,
  )
# str(f)
# get the predicted data, i.e. for y
b06H02b_predict <- predict(b06H02b) %>%
  as_tibble() %>%
  rename(
    pred = Estimate,
    pred_err = Est.Error,
    pred_Q2.5 = Q2.5,
    pred_Q97.5 = Q97.5,
  )
# str(p)
b06H02b_df <- d %>%
  bind_cols(b06H02b_fitted) %>%
  bind_cols(b06H02b_predict)
# glimpse(b06H02a)
```



```{r}
ggplot(data = b06H02b_df, mapping = aes(x = S, y = W)) +
  geom_ribbon(aes(ymin = pred_Q2.5, ymax = pred_Q97.5),
              fill = "thistle1", alpha = 0.5) +
  geom_ribbon(aes(ymin = fit_Q2.5, ymax = fit_Q97.5),
              fill = "thistle3", alpha = 0.5) +
  geom_line(aes(y = fit), color = "thistle4") +
  geom_point(aes(color = group)) +
  geom_jitter(aes(color = group)) +
  scale_color_paletteer_c("oompaBase::jetColors") + 
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Practice 6H2b: Weight vs Group Size",
       color = "group",
       x = "group size (std)", y = "weight (std)")
```



